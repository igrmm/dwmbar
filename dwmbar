#!/bin/sh

DELIMITER="  "
LOGPATH="/tmp/dwmbarlog"

MAIN() {
	case "$1" in
		TIMEDATE)
			TIMEDATE "$2"
			;;
	esac
}

TIMEDATE_FETCH() {
	LOG "Fetching TIMEDATE..."
	[ ! -p /tmp/dwmbar ] && mkfifo /tmp/dwmbar && LOG "mkfifo"
	echo -e "DWMBAR_TIMEDATE=\"$(date '+%Y-%m-%d;%H:%M')"\" >> /tmp/dwmbar
	LOG "TIMEDATE fetched."
	exit
}

TIMEDATE_PRINT() {
	if [ -n "$DWMBAR_TIMEDATE" ]; then
		TIME="$(echo $DWMBAR_TIMEDATE | sed 's/^.*;//')"
		DATE="$(echo $DWMBAR_TIMEDATE | sed 's/;.*//')"
		echo -ne "\x02 $DATE$DELIMITER\x01 $TIME"
	else
		LOG "!TIMEDATE"
	fi
}

TIMEDATE() {
	case "$1" in
		--fetch)
			TIMEDATE_FETCH
			;;
		*)
			TIMEDATE_PRINT
			;;
	esac
}

IMPORT_FIFO() {
	if [ ! -p /tmp/dwmbar ]; then
		xsetroot -name "cant find /tmp/dwmbar!"
		LOG "cant find /tmp/dwmbar!"
		exit
	else
		LOG "importing /tmp/dwmbar..."
		source /tmp/dwmbar
		LOG ".../tmp/dwmbar imported."
	fi
}

BAR() {
	BAR="$(TIMEDATE)"
	echo "$BAR"
}

LOG() {
	echo -e "[$(date '+%Y-%m-%d %H:%M:%S')] $1" >> $LOGPATH
	echo "$1"
}

MAIN "$@"

if mkdir /tmp/dwmbar.lock >/dev/null 2>&1; then
	LOG "Starting dwmbar main loop..."
	xsetroot -name "Starting dwmbar main loop..."
	[ ! -p /tmp/dwmbar ] && mkfifo /tmp/dwmbar
	while [ -d /tmp/dwmbar.lock ]; do
		IMPORT_FIFO
		xsetroot -name "$(BAR)"
	done
	LOG "exiting dwmbar"
	exit
else
	LOG "dwmbar is already running!"
fi
